# Protected App - Internal Server Config
# For use on the internal server (receives traffic from routing server)
# Replace placeholders and copy to /etc/nginx/sites-available/

# Auth response cache - ADD THIS TO http{} BLOCK IN nginx.conf
# proxy_cache_path /tmp/gk_auth_cache levels=1:2 keys_zone=gk_auth:1m max_size=10m inactive=5m;

server {
    listen 80;
    server_name {{DOMAIN}};

    # Internal auth_request location with caching
    location = /_gatekeeper/validate {
        internal;
        proxy_pass http://127.0.0.1:{{GATEKEEPER_PORT}}/api/v1/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-GK-App {{APP_SLUG}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        # Pass cookies for session validation
        proxy_set_header Cookie $http_cookie;

        # Cache auth responses to reduce backend load
        # Uncomment after adding proxy_cache_path to http{} block
        # proxy_cache gk_auth;
        # proxy_cache_key "$cookie_session";
        # proxy_cache_valid 200 5m;
        # proxy_cache_valid 401 403 10s;
    }

    # Protected app content
    location / {
        auth_request /_gatekeeper/validate;

        # Capture auth headers from Gatekeeper response
        auth_request_set $auth_user $upstream_http_x_auth_user;
        auth_request_set $auth_role $upstream_http_x_auth_role;

        # Forward auth info to upstream app
        proxy_set_header X-Auth-User $auth_user;
        proxy_set_header X-Auth-Role $auth_role;

        # Handle auth failures
        # Note: The Gatekeeper URL should be the public URL for redirects
        error_page 401 = @login_redirect;
        error_page 403 = @forbidden;

        # Proxy to upstream app
        proxy_pass http://127.0.0.1:{{UPSTREAM_PORT}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Redirect to Gatekeeper login on 401
    # Replace {{GATEKEEPER_PUBLIC_URL}} with the public Gatekeeper URL
    location @login_redirect {
        # Use X-Forwarded-Proto for the correct scheme in the redirect URL
        set $redirect_scheme $http_x_forwarded_proto;
        if ($redirect_scheme = "") {
            set $redirect_scheme $scheme;
        }
        return 302 {{GATEKEEPER_PUBLIC_URL}}/signin?redirect=$redirect_scheme://$host$request_uri;
    }

    # Show forbidden page on 403
    location @forbidden {
        return 403 "Access denied. You don't have permission to access this app.";
        add_header Content-Type text/plain;
    }
}
