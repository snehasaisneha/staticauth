---
import Layout from '../layouts/Layout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

const appName = import.meta.env.PUBLIC_APP_NAME || 'Gatekeeper';
---

<Layout title="Home">
  <div class="min-h-screen flex flex-col">
    <header class="border-b">
      <div class="container mx-auto px-4 h-16 flex items-center justify-between">
        <a href="/" class="font-semibold text-lg">{appName}</a>
        <nav class="flex items-center gap-4">
          <div id="auth-nav">
            <a href="/signin" class="text-sm text-muted-foreground hover:text-foreground">
              Sign in
            </a>
          </div>
        </nav>
      </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-8">
      <div id="loading" class="text-center py-12">
        <p class="text-muted-foreground">Loading...</p>
      </div>

      <div id="authenticated" class="hidden">
        <div class="max-w-2xl mx-auto space-y-6">
          <h1 class="text-3xl font-bold">Welcome!</h1>
          <p class="text-muted-foreground">You are signed in as <span id="user-email" class="font-medium text-foreground"></span></p>

          <div class="grid gap-4 md:grid-cols-2">
            <Card>
              <CardHeader>
                <CardTitle>Account Settings</CardTitle>
                <CardDescription>Manage your account and security</CardDescription>
              </CardHeader>
              <CardContent>
                <Button variant="outline" id="manage-passkeys-btn" client:load>
                  Manage Passkeys
                </Button>
              </CardContent>
            </Card>

            <Card id="admin-card" class="hidden">
              <CardHeader>
                <CardTitle>Admin Panel</CardTitle>
                <CardDescription>Manage users and registrations</CardDescription>
              </CardHeader>
              <CardContent>
                <Button asChild client:load>
                  <a href="/admin">Go to Admin</a>
                </Button>
              </CardContent>
            </Card>
          </div>

          <div class="pt-4">
            <Button variant="outline" id="signout-btn" client:load>
              Sign Out
            </Button>
          </div>
        </div>
      </div>

      <div id="unauthenticated" class="hidden">
        <div class="max-w-md mx-auto text-center space-y-6 py-12">
          <h1 class="text-3xl font-bold">{appName}</h1>
          <p class="text-muted-foreground">
            Secure authentication for your documentation and internal tools.
          </p>
          <div class="flex gap-4 justify-center">
            <Button asChild client:load>
              <a href="/signin">Sign In</a>
            </Button>
            <Button variant="outline" asChild client:load>
              <a href="/register">Register</a>
            </Button>
          </div>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script>
  async function init() {
    const loadingEl = document.getElementById('loading');
    const authenticatedEl = document.getElementById('authenticated');
    const unauthenticatedEl = document.getElementById('unauthenticated');
    const authNavEl = document.getElementById('auth-nav');
    const userEmailEl = document.getElementById('user-email');
    const adminCardEl = document.getElementById('admin-card');
    const signoutBtn = document.getElementById('signout-btn');
    const managePasskeysBtn = document.getElementById('manage-passkeys-btn');

    try {
      const response = await fetch('/api/v1/auth/me', {
        credentials: 'include',
      });

      if (response.ok) {
        const user = await response.json();

        loadingEl?.classList.add('hidden');
        authenticatedEl?.classList.remove('hidden');

        if (userEmailEl) userEmailEl.textContent = user.email;

        if (user.is_admin && adminCardEl) {
          adminCardEl.classList.remove('hidden');
        }

        if (authNavEl) {
          authNavEl.innerHTML = `<span class="text-sm">${user.email}</span>`;
        }

        signoutBtn?.addEventListener('click', async () => {
          await fetch('/api/v1/auth/signout', {
            method: 'POST',
            credentials: 'include',
          });
          window.location.reload();
        });

        managePasskeysBtn?.addEventListener('click', () => {
          window.location.href = '/account';
        });
      } else {
        loadingEl?.classList.add('hidden');
        unauthenticatedEl?.classList.remove('hidden');
      }
    } catch {
      loadingEl?.classList.add('hidden');
      unauthenticatedEl?.classList.remove('hidden');
    }
  }

  init();
</script>
