---
import Layout from '../../layouts/Layout.astro';
import { AdminDashboard } from '@/components/admin/AdminDashboard';

const appName = import.meta.env.PUBLIC_APP_NAME || 'StaticAuth';
---

<Layout title="Admin">
  <div class="min-h-screen flex flex-col">
    <header class="border-b">
      <div class="container mx-auto px-4 h-16 flex items-center justify-between">
        <a href="/" class="font-semibold text-lg">{appName}</a>
        <nav class="flex items-center gap-4">
          <a href="/" class="text-sm text-muted-foreground hover:text-foreground">Home</a>
          <button id="signout-btn" class="text-sm text-muted-foreground hover:text-foreground">
            Sign Out
          </button>
        </nav>
      </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-8">
      <div id="loading" class="text-center py-12">
        <p class="text-muted-foreground">Loading...</p>
      </div>

      <div id="admin-content" class="hidden">
        <AdminDashboard client:load />
      </div>

      <div id="not-authorized" class="hidden text-center py-12">
        <h2 class="text-2xl font-bold">Access Denied</h2>
        <p class="text-muted-foreground mt-2">You don't have permission to access this page.</p>
        <a href="/" class="text-primary hover:underline mt-4 inline-block">Go back home</a>
      </div>
    </main>
  </div>
</Layout>

<script>
  async function init() {
    const loadingEl = document.getElementById('loading');
    const adminContentEl = document.getElementById('admin-content');
    const notAuthorizedEl = document.getElementById('not-authorized');
    const signoutBtn = document.getElementById('signout-btn');

    try {
      const response = await fetch('/api/v1/auth/me', {
        credentials: 'include',
      });

      if (!response.ok) {
        window.location.href = '/signin';
        return;
      }

      const user = await response.json();

      if (!user.is_admin) {
        loadingEl?.classList.add('hidden');
        notAuthorizedEl?.classList.remove('hidden');
        return;
      }

      loadingEl?.classList.add('hidden');
      adminContentEl?.classList.remove('hidden');

      signoutBtn?.addEventListener('click', async () => {
        await fetch('/api/v1/auth/signout', {
          method: 'POST',
          credentials: 'include',
        });
        window.location.href = '/signin';
      });
    } catch {
      window.location.href = '/signin';
    }
  }

  init();
</script>
