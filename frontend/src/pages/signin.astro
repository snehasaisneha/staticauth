---
import Layout from '../layouts/Layout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { SignInForm } from '@/components/auth/SignInForm';

const appName = import.meta.env.PUBLIC_APP_NAME || 'Gatekeeper';
---

<Layout title="Sign In">
  <div class="min-h-screen flex items-center justify-center p-4">
    <Card class="w-full max-w-md">
      <CardHeader class="text-center pb-2">
        <CardTitle class="text-2xl">{appName}</CardTitle>
        <CardDescription id="signin-description">Sign in to your account</CardDescription>
      </CardHeader>
      <CardContent class="pt-4 pb-8 px-8">
        <SignInForm client:load />
      </CardContent>
    </Card>
  </div>
</Layout>

<script>
  // Redirect to home if already signed in
  async function checkAuth() {
    try {
      const res = await fetch('/api/v1/auth/me', { credentials: 'include' });
      if (res.ok) {
        const params = new URLSearchParams(window.location.search);
        const redirect = params.get('redirect') || '/';
        window.location.href = redirect;
      }
    } catch {}
  }

  // Show app context if ?app= parameter is present
  function showAppContext() {
    const params = new URLSearchParams(window.location.search);
    const appSlug = params.get('app');
    const descriptionEl = document.getElementById('signin-description');

    if (appSlug && descriptionEl) {
      // Fetch app name from public apps endpoint
      fetch('/api/v1/auth/apps/public')
        .then(res => res.json())
        .then(apps => {
          const app = apps.find((a: { slug: string }) => a.slug === appSlug);
          if (app) {
            descriptionEl.textContent = `Sign in to access ${app.name}`;
          }
        })
        .catch(() => {});
    }
  }

  checkAuth();
  showAppContext();
</script>
