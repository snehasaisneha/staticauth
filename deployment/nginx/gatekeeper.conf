# =============================================================================
# Gatekeeper Server Block
# =============================================================================
# Serves the Gatekeeper frontend + API
# NO auth_request - this must be publicly accessible for login/register
#
# Use this as a standalone config or include it in your main routing config
# =============================================================================

# -----------------------------------------------------------------------------
# EDIT: Configuration
# -----------------------------------------------------------------------------

# Gatekeeper backend (FastAPI)
upstream gatekeeper {
    server 127.0.0.1:8000;
    keepalive 16;
}

# Path to built frontend (run: npm -C frontend run build)
map $host $frontend_root {
    default "/opt/gatekeeper/frontend/dist";
}

# Your auth domain
map $host $auth_domain {
    default "auth.example.com";
}

# =============================================================================
# Server Block
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name auth.example.com;  # EDIT: Your auth domain

    # EDIT: SSL certificates
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # -------------------------------------------------------------------------
    # API endpoints
    # -------------------------------------------------------------------------
    # All /api/* requests go to the Gatekeeper backend
    location /api/ {
        proxy_pass http://gatekeeper;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Health check
    # -------------------------------------------------------------------------
    location = /health {
        proxy_pass http://gatekeeper/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # -------------------------------------------------------------------------
    # Frontend (Astro static build)
    # -------------------------------------------------------------------------
    # Serves the login, register, admin pages etc.
    location / {
        root $frontend_root;
        index index.html;

        # SPA fallback - try file, then directory, then index.html
        try_files $uri $uri/ $uri.html /index.html;

        # Cache static assets aggressively
        location ~* \.(?:css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Don't cache HTML (for updates)
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }
    }
}

# =============================================================================
# HTTP redirect (optional - include if not using routing.conf)
# =============================================================================
# server {
#     listen 80;
#     listen [::]:80;
#     server_name auth.example.com;
#
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }
#
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }
