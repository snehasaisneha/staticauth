# =============================================================================
# Main Routing Server
# =============================================================================
# Handles SSL termination, certbot, and routes to Gatekeeper + protected apps
#
# CONFIGURE: Search for "EDIT:" comments below
# =============================================================================

# -----------------------------------------------------------------------------
# EDIT: Your domain
# -----------------------------------------------------------------------------
# Used for cookie domain and building URLs
map $host $base_domain {
    default "example.com";
}

# -----------------------------------------------------------------------------
# EDIT: Gatekeeper backend
# -----------------------------------------------------------------------------
upstream gatekeeper_backend {
    server 127.0.0.1:8000;
    keepalive 16;
}

# -----------------------------------------------------------------------------
# EDIT: Path to Gatekeeper frontend build
# -----------------------------------------------------------------------------
# This is the built Astro frontend (npm -C frontend run build)
map $host $gatekeeper_frontend {
    default "/opt/gatekeeper/frontend/dist";
}

# =============================================================================
# HTTP → HTTPS redirect
# =============================================================================
server {
    listen 80;
    listen [::]:80;

    # EDIT: All your domains
    server_name example.com *.example.com;

    # Certbot challenge (leave as-is)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# =============================================================================
# Gatekeeper (auth.example.com)
# =============================================================================
# NO auth_request here - this must be publicly accessible for login/register
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # EDIT: Your auth subdomain
    server_name auth.example.com;

    # EDIT: SSL certificates (managed by certbot)
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # -------------------------------------------------------------------------
    # API endpoints → proxy to Gatekeeper backend
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://gatekeeper_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Health check (for monitoring)
    # -------------------------------------------------------------------------
    location /health {
        proxy_pass http://gatekeeper_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # -------------------------------------------------------------------------
    # Frontend static files (Astro build)
    # -------------------------------------------------------------------------
    location / {
        root $gatekeeper_frontend;
        index index.html;
        try_files $uri $uri/ $uri.html /index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}

# =============================================================================
# Protected App Template
# =============================================================================
# Copy this block for each app you want to protect
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # EDIT: Your app's subdomain
    server_name docs.example.com;

    # EDIT: SSL certificates
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # -------------------------------------------------------------------------
    # EDIT: App configuration
    # -------------------------------------------------------------------------
    # App slug (must match what's registered in Gatekeeper)
    set $app_slug "docs";

    # EDIT: Where your app runs (or use root for static files)
    # Option A: Proxy to backend
    set $app_backend "http://127.0.0.1:3000";
    # Option B: Serve static files (uncomment and set path)
    # set $app_root "/var/www/docs";

    # -------------------------------------------------------------------------
    # Auth validation endpoint (internal)
    # -------------------------------------------------------------------------
    location = /_gatekeeper/validate {
        internal;
        proxy_pass http://gatekeeper_backend/api/v1/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-GK-App $app_slug;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        # Optional: Auth caching (uncomment after adding proxy_cache_path to nginx.conf)
        # proxy_cache gatekeeper_auth;
        # proxy_cache_key "$cookie_gk_session";
        # proxy_cache_valid 200 5m;
        # proxy_cache_valid 401 403 10s;
    }

    # -------------------------------------------------------------------------
    # All requests require authentication
    # -------------------------------------------------------------------------
    location / {
        auth_request /_gatekeeper/validate;

        # Capture auth response headers
        auth_request_set $auth_user $upstream_http_x_auth_user;
        auth_request_set $auth_user_id $upstream_http_x_auth_user_id;
        auth_request_set $auth_role $upstream_http_x_auth_role;

        # Forward user info to your app
        proxy_set_header X-Auth-User $auth_user;
        proxy_set_header X-Auth-User-Id $auth_user_id;
        proxy_set_header X-Auth-Role $auth_role;

        # Handle auth failures
        error_page 401 = @login_redirect;
        error_page 403 = @access_denied;

        # Proxy to app backend
        proxy_pass $app_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # -------------------------------------------------------------------------
    # Redirect to Gatekeeper login
    # -------------------------------------------------------------------------
    location @login_redirect {
        return 302 https://auth.$base_domain/signin?redirect=$scheme://$host$request_uri;
    }

    # -------------------------------------------------------------------------
    # Access denied (authenticated but no app access)
    # -------------------------------------------------------------------------
    location @access_denied {
        # Option A: Redirect to request access page
        return 302 https://auth.$base_domain/request-access?app=$app_slug&redirect=$scheme://$host$request_uri;

        # Option B: Show inline error (uncomment to use)
        # default_type text/html;
        # return 403 '<html><body><h1>Access Denied</h1><p>You don\'t have access to this app.</p><a href="https://auth.$base_domain">Go to Gatekeeper</a></body></html>';
    }
}
