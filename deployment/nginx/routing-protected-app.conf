# =============================================================================
# Routing: Protected App (runs on Routing server)
# =============================================================================
# Public endpoint that validates auth via Gatekeeper, then proxies to app.
# Copy this file for each protected app. No HTTPS - run certbot after nginx -t.
#
# EDIT: Change the 5 values marked below
# =============================================================================

server {
    listen 80;
    server_name app.example.com;  # EDIT: your app domain

    # Auth validation (internal subrequest to Gatekeeper)
    location = /_gk/validate {
        internal;
        proxy_pass http://10.0.0.10:8000/api/v1/auth/validate;  # EDIT: Gatekeeper private IP:port
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-GK-App myapp;  # EDIT: app slug (must match Gatekeeper registration)
        proxy_set_header Cookie $http_cookie;
    }

    # All requests: validate auth, then proxy to app
    location / {
        auth_request /_gk/validate;
        auth_request_set $auth_user $upstream_http_x_auth_user;

        proxy_pass http://10.0.0.20:8000;  # EDIT: App server private IP:port
        proxy_set_header Host $host;
        proxy_set_header X-Auth-User $auth_user;
        proxy_set_header X-Forwarded-Proto $scheme;

        error_page 401 = @login;
        error_page 403 = @denied;
    }

    # 401: Not logged in -> redirect to Gatekeeper signin
    location @login {
        return 302 https://auth.example.com/signin?redirect=$scheme://$host$request_uri;  # EDIT: Gatekeeper public URL
    }

    # 403: Logged in but no access -> redirect to request access page
    location @denied {
        return 302 https://auth.example.com/request-access?app=myapp;  # EDIT: Gatekeeper URL + app slug
    }
}
